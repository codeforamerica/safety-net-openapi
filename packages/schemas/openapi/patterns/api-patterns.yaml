# API Design Patterns Configuration
# This file defines the patterns and conventions for all APIs in this project.
# Used by: validation scripts, template generators, and AI agents.

version: "1.0"

# =============================================================================
# Naming Conventions
# =============================================================================
naming:
  # URL path segments: kebab-case (lowercase with hyphens)
  # Example: /user-profiles, /order-items
  paths: kebab-case

  # Path parameters: camelCase inside braces
  # Example: /users/{userId}, /orders/{orderId}
  path_parameters: camelCase

  # Query parameters: camelCase
  # Example: ?pageSize=10, ?sortOrder=desc
  query_parameters: camelCase

  # Operation IDs: camelCase verb + noun
  # Example: listPersons, createApplication, getHouseholdById
  operation_ids: camelCase

  # Schema/component names: PascalCase
  # Example: Person, ApplicationCreate, HouseholdList
  schemas: PascalCase

  # File names: kebab-case
  # Example: user-profiles.yaml, common-parameters.yaml
  files: kebab-case

# =============================================================================
# List Endpoint Pattern
# =============================================================================
list_endpoints:
  # All list endpoints (GET /resources) must include these parameters
  required_parameters:
    - ref: "./components/common-parameters.yaml#/SearchQueryParam"
      name: q
      description: Search query using field:value syntax
    - ref: "./components/common-parameters.yaml#/LimitParam"
      name: limit
      description: Maximum items to return (1-100, default 25)
    - ref: "./components/common-parameters.yaml#/OffsetParam"
      name: offset
      description: Number of items to skip (default 0)

  # Response schema must include these properties
  response:
    required_properties:
      - name: items
        type: array
        description: Array of resources
      - name: total
        type: integer
        description: Total number of matching resources
      - name: limit
        type: integer
        description: Requested limit value
      - name: offset
        type: integer
        description: Requested offset value
    recommended_properties:
      - name: hasNext
        type: boolean
        description: Whether more results exist beyond current page

  # Response schema naming: {Resource}List
  # Example: PersonList, ApplicationList
  response_schema_suffix: List

# =============================================================================
# Search Query Syntax
# =============================================================================
search_syntax:
  parameter_name: q
  description: |
    Search query using field:value syntax. Multiple conditions separated by
    spaces are ANDed together.

  operators:
    - pattern: "term"
      description: Full-text search across all searchable fields
      example: "john"
    - pattern: "field:value"
      description: Exact match on field
      example: "status:approved"
    - pattern: "field:>value"
      description: Greater than
      example: "income:>1000"
    - pattern: "field:>=value"
      description: Greater than or equal
      example: "income:>=1000"
    - pattern: "field:<value"
      description: Less than
      example: "income:<5000"
    - pattern: "field:<=value"
      description: Less than or equal
      example: "income:<=5000"
    - pattern: "field:val1,val2"
      description: Match any value (OR)
      example: "status:approved,pending"
    - pattern: "-field:value"
      description: Exclude/negate
      example: "-status:denied"
    - pattern: "field:*"
      description: Field exists (not null)
      example: "email:*"
    - pattern: "field.nested:value"
      description: Nested field using dot notation
      example: "address.state:CA"

# =============================================================================
# CRUD Operations
# =============================================================================
crud_operations:
  # CREATE - POST /resources
  create:
    method: POST
    path_pattern: "/{resources}"
    success_response:
      code: 201
      description: Resource created successfully
      headers:
        - name: Location
          description: URL of the newly created resource
          format: uri
      body: Created resource object
    error_responses: [400, 422, 500]
    request_body:
      required: true
      schema_suffix: Create
      description: "Payload to create a new {resource}"

  # READ (single) - GET /resources/{id}
  read:
    method: GET
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 200
      description: Resource retrieved successfully
      body: Resource object
    error_responses: [404, 500]

  # READ (list) - GET /resources
  list:
    method: GET
    path_pattern: "/{resources}"
    success_response:
      code: 200
      description: Paginated list of resources
      body: List response with items array
    error_responses: [400, 500]
    parameters: See list_endpoints section

  # UPDATE - PATCH /resources/{id}
  update:
    method: PATCH
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 200
      description: Resource updated successfully
      body: Updated resource object
    error_responses: [400, 404, 422, 500]
    request_body:
      required: true
      schema_suffix: Update
      description: "Partial update payload for {resource}"

  # DELETE - DELETE /resources/{id}
  delete:
    method: DELETE
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 204
      description: Resource deleted successfully
      body: null
    error_responses: [404, 500]

# =============================================================================
# Shared Components
# =============================================================================
shared_components:
  # Error responses - use $ref to these
  error_responses:
    400:
      ref: "./components/common-responses.yaml#/BadRequest"
      description: Invalid request parameters or body
    404:
      ref: "./components/common-responses.yaml#/NotFound"
      description: Resource not found
    422:
      ref: "./components/common-responses.yaml#/UnprocessableEntity"
      description: Request body failed validation
    500:
      ref: "./components/common-responses.yaml#/InternalError"
      description: Unexpected server error

  # Query parameters - use $ref to these
  parameters:
    search:
      ref: "./components/common-parameters.yaml#/SearchQueryParam"
    limit:
      ref: "./components/common-parameters.yaml#/LimitParam"
    offset:
      ref: "./components/common-parameters.yaml#/OffsetParam"

  # Reusable schemas - import and reference as needed
  reusable_schemas:
    - ref: "./components/common.yaml#/Address"
      description: Physical mailing address
      fields: [addressLine1, addressLine2, city, stateProvince, postalCode, county]
    - ref: "./components/common.yaml#/Name"
      description: Person's name
      fields: [firstName, middleInitial, middleName, lastName, maidenName]
    - ref: "./components/common.yaml#/PhoneNumber"
      description: Phone number with regex validation
      pattern: '^\+?[0-9 .\-()]{7,20}$'
    - ref: "./components/common.yaml#/Email"
      description: Email address
      format: email
      maxLength: 320

# =============================================================================
# Schema Patterns
# =============================================================================
schema_patterns:
  # Every resource should have these standard fields
  resource_base_fields:
    - name: id
      type: string
      format: uuid
      readOnly: true
      description: Unique identifier (server-generated)
    - name: createdAt
      type: string
      format: date-time
      readOnly: true
      description: Timestamp when resource was created
    - name: updatedAt
      type: string
      format: date-time
      readOnly: true
      description: Timestamp when resource was last updated

  # Common field patterns
  common_fields:
    # Dates
    date_of_birth:
      type: string
      format: date
      example: "1990-05-15"

    # SSN (optional, sensitive)
    social_security_number:
      type: string
      pattern: '^\d{3}-\d{2}-\d{4}$'
      example: "123-45-6789"

    # Money/currency
    monetary_amount:
      type: number
      minimum: 0
      description: Amount in dollars
      example: 1500.00

    # Status enums
    status_pattern:
      type: string
      enum: Define allowed values
      description: Current status of the resource

  # Schema variants for CRUD
  schema_variants:
    base:
      description: Full resource schema with all fields
      suffix: ""
    create:
      description: Schema for POST requests (excludes readOnly fields)
      suffix: Create
    update:
      description: Schema for PATCH requests (all fields optional except id)
      suffix: Update
    list:
      description: Response schema for GET collection endpoints
      suffix: List

  # Foreign key references to other schemas
  foreign_keys:
    description: |
      Foreign key references use the naming convention {entityName}Id with format: uuid.
      This enables automatic relationship detection in tooling like the design reference.
    naming_convention:
      pattern: "{SchemaName}Id"
      format: uuid
      example: "personId references Person, householdId references Household"
    examples:
      - field: personId
        type: string
        format: uuid
        description: Reference to the Person record
        references: Person
      - field: applicationId
        type: string
        format: uuid
        description: Reference to the Application record
        references: Application
    detection:
      - Tooling detects relationships when field ends in 'Id' and has format: uuid
      - The schema name is derived by removing 'Id' suffix and capitalizing
      - Works for both top-level properties and nested array items

# =============================================================================
# File Structure
# =============================================================================
file_structure:
  # Main API specs go in openapi/ root
  api_specs:
    location: "openapi/"
    pattern: "{resource-plural}.yaml"
    examples:
      - openapi/persons.yaml
      - openapi/applications.yaml
      - openapi/households.yaml

  # Shared components in openapi/components/
  components:
    location: "openapi/components/"
    files:
      - common.yaml: Reusable schemas (Address, Name, etc.)
      - common-parameters.yaml: Shared query parameters
      - common-responses.yaml: Shared error responses
      - "{resource}.yaml": Resource-specific schemas

  # Example data in openapi/examples/
  examples:
    location: "openapi/examples/"
    pattern: "{resource-plural}.yaml"
    format: |
      {ResourceName}Example1:
        id: "uuid-here"
        field1: "value1"
        # ... all required fields

  # Generated clients
  generated:
    zodios_clients: "generated/clients/zodios/"
    postman_collection: "generated/postman-collection.json"

# =============================================================================
# Validation Rules
# =============================================================================
validation:
  # These are enforced by npm run validate
  layers:
    - name: syntax
      command: "npm run validate:syntax"
      checks:
        - OpenAPI 3.1 compliance
        - All $ref references resolve
        - Examples match schemas
    - name: lint
      command: "npm run validate:lint"
      checks:
        - Naming conventions (paths, operations, schemas)
        - Response codes (POSTâ†’201, DELETEâ†’204)
        - Content types (application/json)
    - name: patterns
      command: "npm run validate:patterns"
      checks:
        - List endpoints have search/pagination params
        - List responses have required properties
        - Error responses use shared $refs
        - CRUD operations follow patterns
