# API Design Patterns Configuration
# This file defines the patterns and conventions for all APIs in this project.
# Used by: validation scripts, template generators, and AI agents.

version: "1.0"

# =============================================================================
# Pattern Applicability
# =============================================================================
# This project has two API layers (see docs/architecture/domain-design.md):
#
# SYSTEM APIs: RESTful CRUD access to domain data
#   - Example: GET /tasks/{id}, POST /applications, PATCH /cases/{id}
#   - Located in: openapi/domains/
#
# PROCESS APIs: RPC-style orchestration of business operations
#   - Example: POST /processes/applications/submit
#   - Located in: openapi/processes/
#
# Each section below indicates which API type it applies to:
#   [SYSTEM]         - System APIs only
#   [PROCESS]        - Process APIs only
#   [BOTH]           - Both API types
#   [SYSTEM, PROCESS*] - Required for System, optional/varies for Process

# =============================================================================
# Naming Conventions [BOTH]
# =============================================================================
naming:
  # URL path segments: kebab-case (lowercase with hyphens)
  # System API example: /user-profiles, /order-items
  # Process API example: /processes/applications/submit
  paths: kebab-case

  # Path parameters: camelCase inside braces
  # Example: /users/{userId}, /orders/{orderId}
  path_parameters: camelCase

  # Query parameters: camelCase
  # Example: ?pageSize=10, ?sortOrder=desc
  query_parameters: camelCase

  # Operation IDs: camelCase verb + noun
  # System API example: listPersons, createApplication, getHouseholdById
  # Process API example: submitApplication, determineEligibility, reassignTasks
  operation_ids: camelCase

  # Schema/component names: PascalCase
  # System API example: Person, ApplicationCreate, HouseholdList (resource schemas)
  # Process API example: SubmitApplicationRequest, SubmitApplicationResponse (DTOs)
  schemas: PascalCase

  # File names: kebab-case
  # Example: user-profiles.yaml, common-parameters.yaml
  files: kebab-case

# =============================================================================
# List Endpoint Pattern [SYSTEM]
# =============================================================================
# Process APIs do not have list endpoints - they perform actions, not queries.
list_endpoints:
  # All list endpoints (GET /resources) must include these parameters
  required_parameters:
    - ref: "./components/common-parameters.yaml#/SearchQueryParam"
      name: q
      description: Search query using field:value syntax
    - ref: "./components/common-parameters.yaml#/LimitParam"
      name: limit
      description: Maximum items to return (1-100, default 25)
    - ref: "./components/common-parameters.yaml#/OffsetParam"
      name: offset
      description: Number of items to skip (default 0)

  # Response schema must include these properties
  response:
    required_properties:
      - name: items
        type: array
        description: Array of resources
      - name: total
        type: integer
        description: Total number of matching resources
      - name: limit
        type: integer
        description: Requested limit value
      - name: offset
        type: integer
        description: Requested offset value
    recommended_properties:
      - name: hasNext
        type: boolean
        description: Whether more results exist beyond current page

  # Response schema naming: {Resource}List
  # Example: PersonList, ApplicationList
  response_schema_suffix: List

# =============================================================================
# Search Query Syntax [SYSTEM]
# =============================================================================
# Process APIs do not use search - they receive explicit request payloads.
search_syntax:
  parameter_name: q
  description: |
    Search query using field:value syntax. Multiple conditions separated by
    spaces are ANDed together.

  operators:
    - pattern: "term"
      description: Full-text search across all searchable fields
      example: "john"
    - pattern: "field:value"
      description: Exact match on field
      example: "status:approved"
    - pattern: "field:>value"
      description: Greater than
      example: "income:>1000"
    - pattern: "field:>=value"
      description: Greater than or equal
      example: "income:>=1000"
    - pattern: "field:<value"
      description: Less than
      example: "income:<5000"
    - pattern: "field:<=value"
      description: Less than or equal
      example: "income:<=5000"
    - pattern: "field:val1,val2"
      description: Match any value (OR)
      example: "status:approved,pending"
    - pattern: "-field:value"
      description: Exclude/negate
      example: "-status:denied"
    - pattern: "field:*"
      description: Field exists (not null)
      example: "email:*"
    - pattern: "field.nested:value"
      description: Nested field using dot notation
      example: "address.state:CA"

# =============================================================================
# CRUD Operations [SYSTEM]
# =============================================================================
# Process APIs are RPC-style (POST with action verbs), not RESTful CRUD.
# Process API pattern: POST /processes/{capability}/{action}
# Example: POST /processes/applications/submit, POST /processes/tasks/bulk-reassign
crud_operations:
  # CREATE - POST /resources
  create:
    method: POST
    path_pattern: "/{resources}"
    success_response:
      code: 201
      description: Resource created successfully
      headers:
        - name: Location
          description: URL of the newly created resource
          format: uri
      body: Created resource object
    error_responses: [400, 422, 500]
    request_body:
      required: true
      schema_suffix: Create
      description: "Payload to create a new {resource}"

  # READ (single) - GET /resources/{id}
  read:
    method: GET
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 200
      description: Resource retrieved successfully
      body: Resource object
    error_responses: [404, 500]

  # READ (list) - GET /resources
  list:
    method: GET
    path_pattern: "/{resources}"
    success_response:
      code: 200
      description: Paginated list of resources
      body: List response with items array
    error_responses: [400, 500]
    parameters: See list_endpoints section

  # UPDATE - PATCH /resources/{id}
  update:
    method: PATCH
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 200
      description: Resource updated successfully
      body: Updated resource object
    error_responses: [400, 404, 422, 500]
    request_body:
      required: true
      schema_suffix: Update
      description: "Partial update payload for {resource}"

  # DELETE - DELETE /resources/{id}
  delete:
    method: DELETE
    path_pattern: "/{resources}/{resourceId}"
    success_response:
      code: 204
      description: Resource deleted successfully
      body: null
    error_responses: [404, 500]

# =============================================================================
# Shared Components [BOTH]
# =============================================================================
# Error responses are shared. Query parameters are System API only.
# Process APIs define their own request/response DTOs.
shared_components:
  # Error responses - use $ref to these
  error_responses:
    400:
      ref: "./components/common-responses.yaml#/BadRequest"
      description: Invalid request parameters or body
    404:
      ref: "./components/common-responses.yaml#/NotFound"
      description: Resource not found
    422:
      ref: "./components/common-responses.yaml#/UnprocessableEntity"
      description: Request body failed validation
    500:
      ref: "./components/common-responses.yaml#/InternalError"
      description: Unexpected server error

  # Query parameters - use $ref to these
  parameters:
    search:
      ref: "./components/common-parameters.yaml#/SearchQueryParam"
    limit:
      ref: "./components/common-parameters.yaml#/LimitParam"
    offset:
      ref: "./components/common-parameters.yaml#/OffsetParam"

  # Reusable schemas - import and reference as needed
  reusable_schemas:
    - ref: "./components/common.yaml#/Address"
      description: Physical mailing address
      fields: [addressLine1, addressLine2, city, stateProvince, postalCode, county]
    - ref: "./components/common.yaml#/Name"
      description: Person's name
      fields: [firstName, middleInitial, middleName, lastName, maidenName]
    - ref: "./components/common.yaml#/PhoneNumber"
      description: Phone number with regex validation
      pattern: '^\+?[0-9 .\-()]{7,20}$'
    - ref: "./components/common.yaml#/Email"
      description: Email address
      format: email
      maxLength: 320

# =============================================================================
# Schema Patterns [SYSTEM, PROCESS*]
# =============================================================================
# System APIs: Use resource schemas with standard base fields (id, createdAt, updatedAt)
# Process APIs: Use purpose-built DTOs (Request/Response suffixes) - may reference
#               System API schemas but define their own request/response shapes.
schema_patterns:
  # Every resource should have these standard fields
  resource_base_fields:
    - name: id
      type: string
      format: uuid
      readOnly: true
      description: Unique identifier (server-generated)
    - name: createdAt
      type: string
      format: date-time
      readOnly: true
      description: Timestamp when resource was created
    - name: updatedAt
      type: string
      format: date-time
      readOnly: true
      description: Timestamp when resource was last updated

  # Common field patterns
  common_fields:
    # Dates
    date_of_birth:
      type: string
      format: date
      example: "1990-05-15"

    # SSN (optional, sensitive)
    social_security_number:
      type: string
      pattern: '^\d{3}-\d{2}-\d{4}$'
      example: "123-45-6789"

    # Money/currency
    monetary_amount:
      type: number
      minimum: 0
      description: Amount in dollars
      example: 1500.00

    # Status enums
    status_pattern:
      type: string
      enum: Define allowed values
      description: Current status of the resource

  # Schema variants for CRUD
  schema_variants:
    base:
      description: Full resource schema with all fields
      suffix: ""
    create:
      description: Schema for POST requests (excludes readOnly fields)
      suffix: Create
    update:
      description: Schema for PATCH requests (all fields optional except id)
      suffix: Update
    list:
      description: Response schema for GET collection endpoints
      suffix: List

# =============================================================================
# File Structure [BOTH]
# =============================================================================
# System APIs in openapi/domains/, Process APIs in openapi/processes/
file_structure:
  # Main API specs go in openapi/ root
  api_specs:
    location: "openapi/"
    pattern: "{resource-plural}.yaml"
    examples:
      - openapi/persons.yaml
      - openapi/applications.yaml
      - openapi/households.yaml

  # Shared components in openapi/components/
  components:
    location: "openapi/components/"
    files:
      - common.yaml: Reusable schemas (Address, Name, etc.)
      - common-parameters.yaml: Shared query parameters
      - common-responses.yaml: Shared error responses
      - "{resource}.yaml": Resource-specific schemas

  # Example data in openapi/examples/
  examples:
    location: "openapi/examples/"
    pattern: "{resource-plural}.yaml"
    format: |
      {ResourceName}Example1:
        id: "uuid-here"
        field1: "value1"
        # ... all required fields

  # Generated clients
  generated:
    zodios_clients: "generated/clients/zodios/"
    postman_collection: "generated/postman-collection.json"

# =============================================================================
# Validation Rules [BOTH]
# =============================================================================
# Syntax and lint rules apply to both. Pattern checks differ by API type.
validation:
  # These are enforced by npm run validate
  layers:
    - name: syntax
      command: "npm run validate:syntax"
      checks:
        - OpenAPI 3.1 compliance
        - All $ref references resolve
        - Examples match schemas
    - name: lint
      command: "npm run validate:lint"
      checks:
        - Naming conventions (paths, operations, schemas)
        - Response codes (POST→201, DELETE→204)
        - Content types (application/json)
    - name: patterns
      command: "npm run validate:patterns"
      checks:
        - List endpoints have search/pagination params
        - List responses have required properties
        - Error responses use shared $refs
        - CRUD operations follow patterns

# =============================================================================
# Error Handling [BOTH]
# =============================================================================
# STATUS: Not yet implemented in mock server or validation
error_handling:
  # Standard error response body structure
  response_body:
    required_fields:
      - name: code
        type: string
        description: Machine-readable error code (e.g., "VALIDATION_ERROR", "RESOURCE_NOT_FOUND")
      - name: message
        type: string
        description: Human-readable error description
    optional_fields:
      - name: details
        type: array
        description: Array of specific field-level errors
        items:
          field: Path to the field with error
          code: Field-specific error code
          message: Field-specific error message
      - name: retryable
        type: boolean
        description: Whether the client should retry the request
      - name: retryAfter
        type: integer
        description: Seconds to wait before retry (for rate limiting)

  # Error code taxonomy
  error_codes:
    validation:
      - MISSING_REQUIRED_FIELD
      - INVALID_FORMAT
      - INVALID_VALUE
      - VALUE_OUT_OF_RANGE
      - FIELD_TOO_LONG
    business_rules:
      - DUPLICATE_RESOURCE
      - INVALID_STATE_TRANSITION
      - PREREQUISITE_NOT_MET
      - RESOURCE_LOCKED
      - SLA_CONSTRAINT_VIOLATED
    authorization:
      - UNAUTHORIZED
      - FORBIDDEN
      - INSUFFICIENT_PERMISSIONS
    system:
      - SERVICE_UNAVAILABLE
      - UPSTREAM_TIMEOUT
      - INTERNAL_ERROR

  # HTTP status code guidance
  http_status_guidance:
    400:
      description: Malformed request (can't parse JSON, missing required query params)
      retryable: false
    401:
      description: Authentication required or invalid credentials
      retryable: false
    403:
      description: Authenticated but not authorized for this resource/action
      retryable: false
    404:
      description: Resource not found
      retryable: false
    409:
      description: Conflict (duplicate resource, concurrent modification)
      retryable: true
      note: Client should fetch current state and retry
    422:
      description: Valid JSON but fails business validation
      retryable: false
    429:
      description: Rate limited
      retryable: true
      note: Use retryAfter header
    500:
      description: Unexpected server error
      retryable: true
    503:
      description: Service temporarily unavailable
      retryable: true

# =============================================================================
# API Versioning [BOTH]
# =============================================================================
# STATUS: Not yet implemented
versioning:
  strategy: url-path
  description: Version in URL path (e.g., /v1/tasks, /v2/tasks)

  current_version: v1
  supported_versions:
    - v1

  compatibility_rules:
    backward_compatible:
      - Adding new optional request fields
      - Adding new response fields
      - Adding new endpoints
      - Adding new enum values (clients must ignore unknown values)
      - Adding new optional query parameters
    breaking_changes:
      - Removing fields
      - Changing field types
      - Renaming fields
      - Removing enum values
      - Changing URL paths
      - Making optional fields required

  deprecation:
    notice_period_months: 6
    headers:
      - name: Deprecation
        value: "true"
        description: Indicates endpoint is deprecated
      - name: Sunset
        value: "<ISO 8601 date>"
        description: Date when endpoint will be removed
      - name: Link
        value: "<url>; rel=\"successor-version\""
        description: Link to replacement endpoint/documentation

# =============================================================================
# Idempotency [PROCESS required, SYSTEM for POST only]
# =============================================================================
# STATUS: Not yet implemented in mock server
# Process APIs: Required for all POST operations (actions may have side effects)
# System APIs: Required for POST (create) operations only
idempotency:
  description: |
    Ensures that retrying a request (due to network issues, timeouts, etc.)
    does not cause duplicate side effects. Critical for Process APIs.

  applies_to:
    process_apis: All POST operations (required)
    system_apis: POST operations that create resources

  mechanism:
    header_name: Idempotency-Key
    format: Client-generated UUID v4
    required: true for applicable operations
    behavior: |
      1. Client generates unique key and includes in request header
      2. Server checks if key has been seen within retention window
      3. If seen: return stored response (do not re-execute)
      4. If new: execute operation, store response with key
    retention_hours: 24
    note: Keys are scoped per client/tenant

  response_headers:
    - name: Idempotent-Replayed
      values: ["true", "false"]
      description: Indicates whether this response is a replay of a previous request

  error_cases:
    - code: IDEMPOTENCY_KEY_REUSED
      status: 422
      description: Same key used with different request body
    - code: IDEMPOTENCY_KEY_MISSING
      status: 400
      description: Required idempotency key not provided

# =============================================================================
# Batch Operations [SYSTEM primarily, PROCESS rarely]
# =============================================================================
# STATUS: Not yet implemented
# System APIs: Common for bulk CRUD (e.g., PATCH /tasks/batch)
# Process APIs: Rare; most process operations are single-action. If needed,
#               the process itself handles multiple items (e.g., bulk-reassign).
batch_operations:
  description: |
    For operations that need to affect multiple resources in a single request.
    Useful for bulk updates, imports, and administrative operations.
    Primarily for System APIs; Process APIs typically handle batching internally.

  endpoint_pattern: "/{resources}/batch"
  method: POST

  request_body:
    structure:
      operations:
        type: array
        max_items: 100
        items:
          action:
            type: string
            enum: [create, update, delete]
          id:
            type: string
            description: Required for update/delete, omit for create
          data:
            type: object
            description: Resource payload (for create/update)

  response:
    structure:
      total: Total operations requested
      succeeded: Count of successful operations
      failed: Count of failed operations
      results:
        type: array
        items:
          index: Position in request array
          action: The action attempted
          status: "succeeded" | "failed"
          id: Resource ID (for successful creates)
          error: Error details (for failures)

  behavior:
    atomicity: false
    description: |
      Batch operations use partial success model - individual operations
      may succeed or fail independently. Client must check results array
      to determine outcome of each operation.
    ordering: Operations processed sequentially in array order
    rate_limiting: Batch counts as N requests toward rate limit

  idempotency:
    description: Batch operations require idempotency key
    scope: Entire batch (not individual operations)
